/* date 10 May 1993
   Source file for crc.c version 1.0
   by Steven Siew
*/
#include <stdio.h>
#include "general.h"
#include "unos.h"

#define max_message_length 256
#define StartOfFrame  255

unsigned int crctable[256]={
0x0000,0xd801,0xf001,0x2800,0xa001,0x7800,0x5000,0x8801,
0xc0c1,0x18c0,0x30c0,0xe8c1,0x60c0,0xb8c1,0x90c1,0x48c0,
0xc181,0x1980,0x3180,0xe981,0x6180,0xb981,0x9181,0x4980,
0x0140,0xd941,0xf141,0x2940,0xa141,0x7940,0x5140,0x8941,
0xc301,0x1b00,0x3300,0xeb01,0x6300,0xbb01,0x9301,0x4b00,
0x03c0,0xdbc1,0xf3c1,0x2bc0,0xa3c1,0x7bc0,0x53c0,0x8bc1,
0x0280,0xda81,0xf281,0x2a80,0xa281,0x7a80,0x5280,0x8a81,
0xc241,0x1a40,0x3240,0xea41,0x6240,0xba41,0x9241,0x4a40,
0xc601,0x1e00,0x3600,0xee01,0x6600,0xbe01,0x9601,0x4e00,
0x06c0,0xdec1,0xf6c1,0x2ec0,0xa6c1,0x7ec0,0x56c0,0x8ec1,
0x0780,0xdf81,0xf781,0x2f80,0xa78a,0x7f80,0x5780,0x8f81,
0xc741,0x1f40,0x3740,0xef41,0x6740,0xbf41,0x9741,0x4f40,
0x0500,0xdd01,0xf501,0x2d00,0xa501,0x7d00,0x5500,0x8d01,
0xc5c1,0x1dc0,0x35c0,0xedc1,0x65c0,0xbdc1,0x95c1,0x4dc0,
0xc481,0x1c80,0x3480,0xec81,0x6480,0xbc81,0x9481,0x4c80,
0x0440,0xdc41,0xf441,0x2c40,0xa441,0x7c40,0x5440,0x8c41,
0xcc01,0x1400,0x3c00,0xe401,0x6c00,0xb401,0x9c01,0x4400,
0x0cc0,0xd4c1,0xfcc1,0x24c0,0xacc1,0x74c0,0x5cc0,0x84c1,
0x0d80,0xd581,0xfd81,0x2580,0xad81,0x7580,0x5d80,0x8581,
0xcd41,0x1540,0x3d40,0xe541,0x6d40,0xb541,0x9d41,0x4540,
0x0f00,0xd701,0xff01,0x2700,0xaf01,0x7700,0x5f00,0x8701,
0xcfc1,0x17c0,0x3fc0,0xe7c1,0x6fc0,0xbfc1,0x9fc1,0x47c0,
0xce81,0x1680,0x3e80,0xe681,0x6e80,0xb681,0x9e81,0x4680,
0x0e40,0xd641,0xfe41,0x2640,0xae41,0x7640,0x5e40,0x8641,
0x0a00,0xd201,0xfa01,0x2200,0xaa01,0x7200,0x5a00,0x8201,
0xcac1,0x12c0,0x3ac0,0xe2c1,0x6ac0,0xb2c1,0x9ac1,0x42c0,
0xcb81,0x1380,0x3b80,0xe381,0x6b80,0xb381,0x9b81,0x4380,
0x0b40,0xd341,0xfb41,0x2340,0xab41,0x7340,0x5b40,0x8341,
0xc901,0x1100,0x3900,0xe101,0x6900,0xb101,0x9901,0x4100,
0x09c0,0xd1c1,0xf9c1,0x21c0,0xa9c1,0x71c0,0x59c0,0x81c1,
0x0880,0xd081,0xf881,0x2080,0xa881,0x7080,0x5880,0x8081,
0xc841,0x1040,0x3840,0xe041,0x6840,0xb041,0x9841,0x4040 };

/* testing purposes only */
void sendbytetoserial(unsigned char byte)
{ byte=byte;
}

unsigned int addcrc(char *str,unsigned int strlen)
{
  unsigned int crcreg,i;
  unsigned char t;
  crcreg=0;
  for (i=0;i<strlen;i++)
  {
	t= (unsigned char) (crcreg >> 8);         /* crcreg div 256 */
	t=str[i] ^ t;
	crcreg=crcreg << 8;   /* left shift  */
	crcreg=crcreg ^ crctable[t];
  } /* end while */
  return crcreg;
}

void init_send_protocol_task(void)
{

}

void send_protocol_task(void* local_var_ptr)
{
  unsigned char mess_ptr[max_message_length],*caller;
  unsigned char frame[max_message_length+5];
  unsigned char mess_lgthHB,mess_lgthLB,crcHB,crcLB,start_of_frame;
  unsigned int mess_lgth,CRC,i;
  /* Initialisation of constants */
  local_var_ptr=local_var_ptr;
  start_of_frame=StartOfFrame;

  for(;;) /* infinite loop */
  {
    caller=rcv_mess( mess_ptr,&mess_lgth,10);
    if (caller!=NULL)  /* if there is mess to send */
    { CRC=addcrc(mess_ptr,mess_lgth);  /* calculate CRC */
      crcHB=CRC/256; /* high order byte of CRC */
      crcLB=CRC%256; /* low  order byte of CRC */
      mess_lgthHB=mess_lgth/256; /* high order byte of mess_lgth */
      mess_lgthLB=mess_lgth%256; /* low  order byte of mess_lgth */
      sendbytetoserial(start_of_frame);
      sendbytetoserial(mess_lgthHB);
      sendbytetoserial(mess_lgthLB);
      for(i=0;i<mess_lgth;i++) sendbytetoserial(mess_ptr[i]);
      sendbytetoserial(crcHB);
      sendbytetoserial(crcLB);
    } /* end if */
  } /* end for */
}

